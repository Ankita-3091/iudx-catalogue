#!bin/bash
echo "Packaging apiserver jar"
cd .. 
mvn clean install
cd install

echo "Setting MongoDB up"
docker-compose up -d

until nc -z localhost 27017
echo "Checking MondoDB status"

do
    sleep 1
    echo "Waiting to boot..."
done

echo "MongoDB is up at PORT 27017"

echo "Configuring Catalogue"
sleep 5

until nc -z localhost 27017
do
    sleep 1
    echo "Waiting to boot..."
done

docker exec catalogue-database-mongodb /root/setup.sh
echo "Catalogue Setup - Created Database (catalogue)"

echo "Catalogue Setup - Created Collections (items and schemas)"

echo "Catalogue Setup Completed"

cd ..

docker cp target/catalogue-apiserver-0.0.1-jar-with-dependencies.jar catalogue-apiserver:/
echo "Copied jar to apiserver container"
docker cp my-keystore.jks catalogue-apiserver:/
echo "Copied jks file to apiserver container"

docker cp install/scripts/apiserver/start.sh catalogue-apiserver:/
echo "Copied start file to apiserver container"

docker exec -d catalogue-apiserver ./start.sh
echo "Started apiserver"


